<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ExpeAR Pro - Restauro Architettonico</title>

    <meta name="theme-color" content="#070707">

    <style>
        /* ===== AR Restoration UI ===== */

        /* --- Video & Canvas layers --- */
        #video-container {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        canvas#overlay {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        #three-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* --- Slider --- */
        .restoration-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .restoration-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--p-white);
            border: 2px solid var(--p-gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px var(--p-gold-glow);
            transition: transform 0.2s;
        }

        .restoration-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
    </style>
</head>

<body>

    <!-- Video / Canvas / 3D layers -->
    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
        <div id="three-container"></div>
        <!-- status label (hidden by default, injected for engine) -->
        <div id="tracking-status" style="position:absolute;top:10px;left:10px;z-index:1001;color:#fff;font-weight:bold;pointer-events:none;display:none;"></div>
    </div>
    <!-- Restoration slider -->
    <input type="range" id="restoration-range" min="0" max="100" value="0" style="position:absolute;bottom:20px;left:5%;width:90%;z-index:1000;">
    <!-- Model Y offset tuning (cm) -->
    <div style="position:absolute;top:10px;right:10px;z-index:1002;background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:8px;color:#fff;font:12px/1.4 sans-serif;">
        <div>Offset Y: <span id="model-y-offset-value">0.0 cm</span></div>
        <input type="range" id="model-y-offset" min="-30" max="30" step="0.5" value="0" style="width:180px;">
    </div>


    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
        onerror="window.log && window.log('Errore Three.js CDN','error')"></script>
    <script src="vendor/fflate.min.js"
        onerror="window.log && window.log('Errore fflate locale (vendor/fflate.min.js)','error')"></script>
    <script>

    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"
        onerror="window.log && window.log('Errore FBXLoader','error')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- js-aruco2 runtime dependency -->
    <script src="vendor/js-aruco2.js"></script>

    <!-- App Logic -->
    <script>
        // Global error catcher
        window.onerror = function (msg, url, line, col) {
            if (window.log) window.log('GLOBAL ERROR: ' + msg + ' at ' + line + ':' + col, 'error');
            return false;
        };

        function log(msg, type) {
            type = type || 'info';
            console.log('[' + type + '] ' + msg);
        }
        window.log = log;

        log('Pagina caricata. Controllo librerie...');

        setTimeout(function () {
            if (typeof THREE === 'undefined') log('THREE.js non caricato!', 'error');
            else log('THREE.js v' + THREE.REVISION);
            if (typeof fflate === 'undefined') log('fflate non caricato!', 'error');
            else log('fflate OK');
            if (typeof AR !== 'undefined' && AR.Detector) log('js-aruco2 OK');
            else log('js-aruco2 non caricato!', 'error');
        }, 1200);
    </script>

    <script type="module">
        // cache-bust by appending version parameter (update when code changes)
        import { RestorationEngine } from './utils/restoration-engine.js?v=3';

        async function main() {
            const engine = new RestorationEngine();
            window.engine = engine; // expose for debugging/tests
            engine._validMarkerIds = new Set([1]);
            engine._singleMarkerMode = true;
            engine.markerSizeMM = 150;
            engine._dictionaryName = 'ARUCO';
            engine._detectionFps = 24;
            engine._minMarkerPerimeter = 40;
            engine._maxDetectSize = 768;
            engine._debugOverlayEnabled = false;
            engine.showMarkerHelpers(false);

            try {
                localStorage.removeItem('expear.markerOffsets.v4');
                localStorage.removeItem('expear.anchorIds');
                localStorage.removeItem('expear.anchorLock.v2');
            } catch (_e) {}

            engine.setMarkerOffsets({1:{pos:[0,0,0],quat:[0,0,0,1]}},{persist:true});
            if (typeof engine.setUseAprilTag==='function') engine.setUseAprilTag(false);
            if (typeof engine.setCornerFlowEnabled==='function') engine.setCornerFlowEnabled(false);
            if (typeof engine.setCornerSmoothing==='function') engine.setCornerSmoothing(0);
            if (typeof engine.setAnchorIds==='function') engine.setAnchorIds([1]);

            await engine.init();
            if (typeof engine.setModelYOffset === 'function') engine.setModelYOffset(0);
            console.log('engine ready');
        }

        main();

        // slider event
        const slider = document.getElementById('restoration-range');
        if (slider) {
            slider.addEventListener('input', (e) => {
                if (window.engine) window.engine.setRestorationLevel(e.target.value/100);
            });
        }

        const yOffsetSlider = document.getElementById('model-y-offset');
        const yOffsetValue = document.getElementById('model-y-offset-value');
        if (yOffsetSlider && yOffsetValue) {
            const updateLabel = (cm) => { yOffsetValue.textContent = `${cm.toFixed(1)} cm`; };
            updateLabel(Number(yOffsetSlider.value));
            yOffsetSlider.addEventListener('input', (e) => {
                const cm = Number(e.target.value);
                updateLabel(cm);
                if (window.engine && typeof window.engine.setModelYOffset === 'function') {
                    window.engine.setModelYOffset(cm / 100);
                }
            });
        }
    </script>
</body>

</html>
